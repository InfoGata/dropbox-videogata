(()=>{const e="/nowplaying.json",a="/plugins.json",t="/playlists.json";let s;const o=e=>{application.postUiMessage(e)},c=e=>{s=new Dropbox.DropboxAuth({clientId:e||"a5kcn574s1k88k5"})},n=(e,a)=>{s.setAccessToken(e),s.setRefreshToken(a)},l=async(e,a)=>{const t=new Dropbox.Dropbox({auth:s});await t.filesUpload({path:e,mute:!0,mode:{".tag":"overwrite"},contents:JSON.stringify(a)})},i=async e=>{const a=new Dropbox.Dropbox({auth:s}),t=(await a.filesDownload({path:e})).result.fileBlob,o=await t.text();return JSON.parse(o)};application.onUiMessage=async s=>{switch(s.type){case"login":let p=s.accessToken,r=s.refreshToken;localStorage.setItem("access_token",p),localStorage.setItem("refresh_token",r),n(p,r);break;case"check-login":const g=localStorage.getItem("access_token");g&&o({type:"login",accessToken:g}),await(async()=>{const e=document.location.host.split(".");e.shift();const a=e.join("."),t=`${document.location.protocol}//${a}`,s=await application.getPluginId(),c=localStorage.getItem("clientId")??"";o({type:"info",origin:t,pluginId:s,clientId:c})})();break;case"save":await(async()=>{const a=await application.getNowPlayingTracks();await l(e,a),o({type:"message",message:"Successfully saved Now playing tracks."})})();break;case"load":await(async()=>{const a=await i(e);await application.setNowPlayingTracks(a),o({type:"message",message:"Successfully loaded Now playing tracks."})})();break;case"save-plugins":await(async()=>{const e=await application.getPlugins();await l(a,e),o({type:"message",message:"Successfully saved plugins."})})();break;case"load-plugins":await(async()=>{const e=await i(a);application.installPlugins(e)})();break;case"save-playlists":await(async()=>{const e=await application.getPlaylists();await l(t,e),o({type:"message",message:"Successfully saved playlists."})})();break;case"load-playlists":await(async()=>{const e=await i(t);await application.addPlaylists(e),o({type:"message",message:"Successfully added playlists."})})();break;case"set-keys":localStorage.setItem("clientId",s.clientId),c(s.clientId);break;case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}},application.onDeepLinkMessage=async e=>{application.postUiMessage({type:"deeplink",url:e})};(async()=>{await new Promise(((e,a)=>{const t=document.createElement("script");t.src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js",t.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(t),t.onload=()=>{e()},t.onerror=()=>{a()}}));const e=localStorage.getItem("clientId");c(e);let a=localStorage.getItem("access_token"),t=localStorage.getItem("refresh_token");a&&t&&n(a,t)})()})();